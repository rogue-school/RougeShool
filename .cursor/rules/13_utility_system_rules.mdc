---
description: "UtilitySystem 개발 가이드 및 규칙 - Unity 2D 유틸리티 시스템 통합 관리"
globs: ["Assets/Script/UtilitySystem/**/*.cs"]
rule_id: utility_system_rules
version: 1.3.0
alwaysApply: true
---

# UtilitySystem 개발 규칙

## 📋 시스템 개요
UtilitySystem은 게임의 유틸리티 기능들을 관리하는 시스템입니다. 게임 플로우, DontDestroyOnLoad 관리, 드롭 핸들러 주입 등 다양한 유틸리티 기능을 제공합니다.

## 🏗️ 폴더 구조 규칙 (리팩토링 후)
```
UtilitySystem/
├── GameFlow/         # 게임 플로우 (3개 파일)
└── 루트/             # 루트 유틸리티 (2개 파일) - 간소화됨
```

## 📁 주요 컴포넌트 규칙 (리팩토링 후)

### GameFlow 폴더 규칙 (3개 파일)
- **GameContext.cs**: 게임 컨텍스트 관리
- **IGameContext.cs**: 게임 컨텍스트 인터페이스
- **ISceneLoader.cs**: 씬 로더 인터페이스

### 루트 폴더 규칙 (2개 파일) - 간소화됨
- **DontDestroyOnLoadContainer.cs**: DontDestroyOnLoad 오브젝트 관리
- **DropHandlerInjector.cs**: 드롭 핸들러 주입
- ~~**CameraResolutionFixer.cs**: 카메라 해상도 수정~~ (제거됨)

## 🎯 주요 기능

### 1. 게임 플로우 관리
- **게임 컨텍스트**: 게임의 전역 상태 관리
- **씬 로딩**: 씬 전환 및 로딩 관리
- **상태 전환**: 게임 상태 간 전환

### 2. DontDestroyOnLoad 관리
- **오브젝트 등록**: DontDestroyOnLoad로 설정할 오브젝트 등록
- **자동 관리**: 씬 전환 시에도 유지되는 오브젝트 관리
- **생명주기 관리**: 오브젝트의 생성/소멸 관리

### 3. 드롭 핸들러 주입
- **자동 주입**: 드롭 핸들러를 자동으로 주입
- **의존성 관리**: 드롭 핸들러 간 의존성 관리
- **초기화**: 드롭 핸들러의 자동 초기화

### 4. 카메라 해상도 수정 (제거됨)
- ~~**해상도 조정**: 다양한 해상도에 맞춰 카메라 설정 조정~~
- ~~**비율 유지**: 화면 비율 유지~~
- ~~**자동 적용**: 게임 시작 시 자동 적용~~
- **제거 사유**: 불필요한 기능으로 판단되어 제거됨

## 🔧 사용 방법

### 기본 사용법
```csharp
// GameContext를 통한 플레이어 캐릭터 관리
GameContext gameContext = new GameContext();
PlayerCharacterData characterData = Resources.Load<PlayerCharacterData>("Characters/SwordCharacter");
gameContext.SetSelectedCharacter(characterData);

// DontDestroyOnLoadContainer를 통한 오브젝트 관리
DontDestroyOnLoadContainer container = FindObjectOfType<DontDestroyOnLoadContainer>();
container.AddObject(gameObject);
container.RemoveObject(gameObject);
int objectCount = container.GetObjectCount();
bool isEmpty = container.IsEmpty();

// DropHandlerInjector를 통한 드롭 핸들러 주입
ICombatSlotRegistry slotRegistry = FindObjectOfType<CombatSlotRegistry>();
CardDropService dropService = FindObjectOfType<CardDropService>();
ICombatFlowCoordinator flowCoordinator = FindObjectOfType<CombatFlowCoordinator>();
DropHandlerInjector.InjectToAllCombatSlots(slotRegistry, dropService, flowCoordinator);
```

### 주요 클래스 및 메서드

#### GameContext 클래스
- **SetSelectedCharacter(PlayerCharacterData data)**: 선택된 플레이어 캐릭터 설정
- **SelectedCharacter**: 현재 선택된 플레이어 캐릭터 데이터 (프로퍼티)

#### DontDestroyOnLoadContainer 클래스
- **AddObject(GameObject newObject)**: 새로운 오브젝트를 컨테이너에 추가
- **RemoveObject(GameObject objectToRemove)**: 특정 오브젝트를 컨테이너에서 제거
- **GetAllChildren()**: 컨테이너의 모든 하위 오브젝트 목록 반환
- **IsEmpty()**: 컨테이너가 비어있는지 확인
- **GetObjectCount()**: 컨테이너의 오브젝트 개수 반환
- **applyToSelf**: 컨테이너 자체에 DontDestroyOnLoad 적용 여부 (인스펙터 설정)
- **applyToChildren**: 모든 하위 오브젝트에 DontDestroyOnLoad 적용 여부 (인스펙터 설정)
- **applyToNewChildren**: 새로운 오브젝트에 DontDestroyOnLoad 적용 여부 (인스펙터 설정)
- **persistAcrossScenes**: 씬 전환 시 유지 여부 (인스펙터 설정)
- **enableDebugLogging**: 디버그 로깅 활성화 여부 (인스펙터 설정)

#### DropHandlerInjector 클래스 (정적 클래스)
- **InjectToAllCombatSlots(ICombatSlotRegistry slotRegistry, CardDropService dropService, ICombatFlowCoordinator flowCoordinator)**: 모든 전투 슬롯에 드롭 핸들러 주입

#### 인터페이스
- **IGameContext**: 게임 컨텍스트 인터페이스 (SelectedCharacter, SetSelectedCharacter)
- **ISceneLoader**: 씬 로딩 인터페이스 (LoadScene)

## 🏗️ 아키텍처 패턴

### 1. 컨텍스트 패턴 (Context Pattern)
- **GameContext**: 플레이어 캐릭터 선택 상태 관리
- **상태 전환**: 컨텍스트를 통한 캐릭터 상태 전환

### 2. 컨테이너 패턴 (Container Pattern)
- **DontDestroyOnLoadContainer**: 씬 전환 시에도 유지되는 오브젝트 관리
- **자동 관리**: 오브젝트의 생성/소멸 자동 관리

### 3. 의존성 주입 패턴 (Dependency Injection)
- **DropHandlerInjector**: 드롭 핸들러 자동 주입
- **인터페이스 기반**: 인터페이스를 통한 느슨한 결합

### 4. 인터페이스 분리 원칙 (Interface Segregation Principle)
- **IGameContext**: 게임 컨텍스트 인터페이스
- **ISceneLoader**: 씬 로딩 인터페이스

## 🔧 기술적 구현 세부사항

### 성능 최적화
- **메모리 관리**: 오브젝트 풀링을 통한 GC 압박 최소화
- **프레임 최적화**: 씬 전환 시 프레임 블로킹 방지
- **로딩 최적화**: 비동기 씬 로딩

### 스레드 안전성
- **동시성 제어**: 오브젝트 등록/해제 시 동시성 제어
- **비동기 처리**: async/await 패턴을 통한 비동기 씬 로딩
- **이벤트 처리**: 스레드 안전한 유틸리티 이벤트 시스템

### 메모리 관리
- **생명주기 관리**: 오브젝트의 생성/소멸 관리
- **리소스 해제**: 씬 전환 시 리소스 정리
- **메모리 누수 방지**: 이벤트 구독 해제, 오브젝트 참조 해제

## 🧪 검증/테스트 지침

### 체크리스트
- [ ] 게임 컨텍스트 정상 동작 확인
- [ ] DontDestroyOnLoad 기능 검증
- [ ] 드롭 핸들러 주입 정상 동작 확인
- [ ] 씬 전환 시 오브젝트 유지 확인

### 재현 절차
1. 각 유틸리티 기능별 테스트
2. 씬 전환 시나리오 테스트
3. 오브젝트 생명주기 테스트
4. 성능 프로파일링

## 📝 변경 기록(Delta)
- 형식: `YYYY-MM-DD | 작성자 | 변경 요약 | 영향도(코드/씬/문서)`

- 2025-01-27 | Maintainer | UtilitySystem 개발 문서 초기 작성 | 문서
- 2025-01-27 | Maintainer | 실제 폴더 구조 반영 및 파일 수 정정 | 문서
- 2025-01-27 | Maintainer | .mdc 규칙 파일로 변환 및 Cursor 규칙 저장 | 문서
- 2025-01-27 | Maintainer | 실제 코드 분석 기반 구체적 클래스/메서드/인터페이스 정보 추가 | 문서
- 2025-01-27 | Maintainer | UtilitySystem 개발 문서 기반으로 규칙 파일 업데이트 (리팩토링 반영, 카메라 해상도 수정 제거, 클래스/메서드 업데이트) | 문서