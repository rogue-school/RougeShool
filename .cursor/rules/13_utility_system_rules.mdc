---
description: "UtilitySystem 개발 가이드 및 규칙 - Unity 2D 유틸리티 시스템 통합 관리"
globs: ["Assets/Script/UtilitySystem/**/*.cs"]
rule_id: utility_system_rules
version: 1.2.0
alwaysApply: true
---

# UtilitySystem 개발 규칙

## 📋 시스템 개요
UtilitySystem은 게임의 유틸리티 기능들을 관리하는 시스템입니다. 게임 플로우, DontDestroyOnLoad 관리, 드롭 핸들러 주입 등 다양한 유틸리티 기능을 제공합니다.

## 🏗️ 폴더 구조 규칙
```
UtilitySystem/
├── GameFlow/         # 게임 플로우 (3개 파일)
└── 루트/             # 루트 유틸리티 (2개 파일) - 간소화됨
```

## 📁 주요 컴포넌트 규칙

### GameFlow 폴더 규칙 (3개 파일)
- **GameContext.cs**: 게임 컨텍스트 관리
- **IGameContext.cs**: 게임 컨텍스트 인터페이스
- **ISceneLoader.cs**: 씬 로더 인터페이스

### 루트 폴더 규칙 (2개 파일) - 간소화됨
- **DontDestroyOnLoadContainer.cs**: DontDestroyOnLoad 오브젝트 관리
- **DropHandlerInjector.cs**: 드롭 핸들러 주입

## 🎯 개발 규칙

### 1. 게임 플로우 관리 규칙
- **게임 컨텍스트**: 게임의 전역 상태 관리
- **씬 로딩**: 씬 전환 및 로딩 관리
- **상태 전환**: 게임 상태 간 전환

### 2. DontDestroyOnLoad 관리 규칙
- **오브젝트 등록**: DontDestroyOnLoad로 설정할 오브젝트 등록
- **자동 관리**: 씬 전환 시에도 유지되는 오브젝트 관리
- **생명주기 관리**: 오브젝트의 생성/소멸 관리

### 3. 드롭 핸들러 주입 규칙
- **자동 주입**: 드롭 핸들러를 자동으로 주입
- **의존성 관리**: 드롭 핸들러 간 의존성 관리
- **초기화**: 드롭 핸들러의 자동 초기화

## 🔧 사용 방법

### 기본 사용법
```csharp
// GameContext를 통한 플레이어 캐릭터 관리
GameContext gameContext = new GameContext();
PlayerCharacterData characterData = Resources.Load<PlayerCharacterData>("Characters/SwordCharacter");
gameContext.SetPlayerCharacter(characterData);
PlayerCharacterData currentPlayer = gameContext.GetPlayerCharacter();

// DontDestroyOnLoadContainer를 통한 오브젝트 유지
DontDestroyOnLoadContainer.Instance.RegisterObject(gameObject);
DontDestroyOnLoadContainer.Instance.UnregisterObject(gameObject);

// DropHandlerInjector를 통한 드롭 핸들러 주입
DropHandlerInjector.Instance.InjectHandlers();
```

### 주요 클래스 및 메서드

#### GameContext 클래스
- **SetPlayerCharacter(PlayerCharacterData characterData)**: 플레이어 캐릭터 데이터 설정
- **GetPlayerCharacter()**: 플레이어 캐릭터 데이터 조회
- **SetCurrentScene(string sceneName)**: 현재 씬 이름 설정
- **GetCurrentScene()**: 현재 씬 이름 조회
- **SetGameState(GameState state)**: 게임 상태 설정
- **GetGameState()**: 게임 상태 조회
- **SceneLoader**: 씬 로더 인스턴스 (프로퍼티)

#### DontDestroyOnLoadContainer 클래스
- **Instance**: 싱글톤 인스턴스
- **RegisterObject(GameObject obj)**: 오브젝트 등록 (씬 전환 시 유지)
- **UnregisterObject(GameObject obj)**: 오브젝트 등록 해제

#### DropHandlerInjector 클래스
- **Instance**: 싱글톤 인스턴스
- **InjectHandlers()**: 씬 내 모든 드롭 핸들러에 의존성 주입

#### IGameContext 인터페이스
- **SetPlayerCharacter()**: 플레이어 캐릭터 설정
- **GetPlayerCharacter()**: 플레이어 캐릭터 조회
- **SetCurrentScene()**: 현재 씬 설정
- **GetCurrentScene()**: 현재 씬 조회
- **SetGameState()**: 게임 상태 설정
- **GetGameState()**: 게임 상태 조회
- **SceneLoader**: 씬 로더 프로퍼티

#### ISceneLoader 인터페이스
- **LoadScene(string sceneName)**: 씬 로드
- **LoadSceneAsync(string sceneName)**: 씬 비동기 로드

## 🏗️ 아키텍처 패턴

### 1. 컨텍스트 패턴
- **GameContext**: 플레이어 캐릭터 선택 상태 관리
- **상태 전환**: 컨텍스트를 통한 캐릭터 상태 전환

### 2. 컨테이너 패턴
- **DontDestroyOnLoadContainer**: 씬 전환 시에도 유지되는 오브젝트 관리
- **자동 관리**: 오브젝트의 생성/소멸 자동 관리

### 3. 의존성 주입 패턴
- **DropHandlerInjector**: 드롭 핸들러 자동 주입
- **인터페이스 기반**: 인터페이스를 통한 느슨한 결합

### 4. 싱글톤 패턴
- **DontDestroyOnLoadContainer**: 전역 오브젝트 관리
- **DropHandlerInjector**: 전역 드롭 핸들러 주입

## 🔧 기술적 구현 세부사항

### 성능 최적화
- **메모리 관리**: 오브젝트 풀링을 통한 GC 압박 최소화
- **프레임 최적화**: 씬 전환 시 프레임 블로킹 방지
- **로딩 최적화**: 비동기 씬 로딩

### 스레드 안전성
- **동시성 제어**: 오브젝트 등록/해제 시 동시성 제어
- **비동기 처리**: async/await 패턴을 통한 비동기 씬 로딩
- **이벤트 처리**: 스레드 안전한 유틸리티 이벤트 시스템

### 메모리 관리
- **생명주기 관리**: 오브젝트의 생성/소멸 관리
- **리소스 해제**: 씬 전환 시 리소스 정리
- **메모리 누수 방지**: 이벤트 구독 해제, 오브젝트 참조 해제

## 🧪 검증/테스트 지침

### 체크리스트
- [ ] 게임 컨텍스트 정상 동작 확인
- [ ] DontDestroyOnLoad 기능 검증
- [ ] 드롭 핸들러 주입 정상 동작 확인
- [ ] 씬 전환 시 오브젝트 유지 확인

### 재현 절차
1. 각 유틸리티 기능별 테스트
2. 씬 전환 시나리오 테스트
3. 오브젝트 생명주기 테스트
4. 성능 프로파일링

## 📝 변경 기록(Delta)
- 형식: `YYYY-MM-DD | 작성자 | 변경 요약 | 영향도(코드/씬/문서)`

- 2025-01-27 | Maintainer | UtilitySystem 개발 문서 초기 작성 | 문서
- 2025-01-27 | Maintainer | 실제 폴더 구조 반영 및 파일 수 정정 | 문서
- 2025-01-27 | Maintainer | .mdc 규칙 파일로 변환 및 Cursor 규칙 저장 | 문서
- 2025-01-27 | Maintainer | 실제 코드 분석 기반 구체적 클래스/메서드/인터페이스 정보 추가 | 문서