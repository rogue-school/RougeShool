---
description: "CombatSystem 개발 가이드 및 규칙 - Unity 2D 전투 시스템 통합 관리"
globs: ["Assets/Script/CombatSystem/**/*.cs"]
rule_id: combat_system_rules
version: 1.2.0
alwaysApply: true
---

# CombatSystem 개발 규칙

## 📋 시스템 개요
CombatSystem은 4개 전투 슬롯(SLOT_1~SLOT_4)을 축으로 즉시 실행(즉발) 전투를 관리합니다. 적 핸드 슬롯과 턴 시작 버튼은 없으며, 1번 슬롯에서 카드가 존재하는 즉시 실행됩니다. 실행이 끝나면 슬롯은 2→1, 3→2, 4→3으로 이동하며 플레이어 1턴 → 적 1턴이 교대로 반복됩니다.

## 🏗️ 폴더 구조 규칙
```
CombatSystem/
├── Core/             # 핵심 로직 (2개 파일)
├── Manager/          # 매니저 클래스 (3개 파일)
├── Interface/        # 인터페이스 (8개 파일)
├── State/            # 상태 패턴 (6개 파일)
├── Service/          # 서비스 클래스 (3개 파일)
├── Data/             # 데이터 클래스 (1개 파일)
├── Event/            # 이벤트 시스템 (1개 파일)
├── Utility/          # 유틸리티 (2개 파일)
├── Context/          # 컨텍스트 (2개 파일)
└── UI/               # UI 관련 (1개 파일)
```

## 📁 주요 컴포넌트 규칙

### Core 폴더 규칙 (2개 파일)
- **CombatInstaller.cs**: 전투 시스템 의존성 주입 설정
- **CombatContext.cs**: 전투 컨텍스트

### Manager 폴더 규칙 (3개 파일)
- **CombatFlowCoordinator.cs**: 전투 플로우 조정
- **CombatTurnManager.cs**: 턴 매니저
- **CombatSlotManager.cs**: 전투 슬롯 매니저

### Interface 폴더 규칙 (8개 파일)
- **ICombatState.cs**: 전투 상태 인터페이스
- **ICombatAction.cs**: 전투 행동 인터페이스
- **ICombatEffect.cs**: 전투 효과 인터페이스
- **ICombatCard.cs**: 전투 카드 인터페이스
- **ICombatCharacter.cs**: 전투 캐릭터 인터페이스
- **ICombatUI.cs**: 전투 UI 인터페이스
- **ICombatValidator.cs**: 전투 검증 인터페이스
- **ICombatExecutor.cs**: 전투 실행 인터페이스

### State 폴더 규칙 (6개 파일)
- **CombatFirstAttackState.cs**: 첫 번째 공격 상태
- **CombatPlayerInputState.cs**: 플레이어 입력 상태
- **CombatPrepareState.cs**: 준비 상태
- **CombatResultState.cs**: 결과 상태
- **CombatSecondAttackState.cs**: 두 번째 공격 상태
- **CombatVictoryState.cs**: 승리 상태

### Service 폴더 규칙 (3개 파일)
- **CombatExecutorService.cs**: 전투 실행 서비스
- **CombatPreparationService.cs**: 전투 준비 서비스
- **TurnCardRegistry.cs**: 턴 카드 등록기

### Data 폴더 규칙 (1개 파일)
- **SlotOwner.cs**: 슬롯 소유자 열거형

### Event 폴더 규칙 (1개 파일)
- **CombatEventSystem.cs**: 전투 이벤트 시스템

### Utility 폴더 규칙 (2개 파일)
- **CardValidator.cs**: 카드 검증기
- **CharacterDeathHandler.cs**: 캐릭터 사망 핸들러

### Context 폴더 규칙 (2개 파일)
- **CombatContext.cs**: 전투 컨텍스트
- **TurnContext.cs**: 턴 컨텍스트

### UI 폴더 규칙 (1개 파일)
- **CombatUI.cs**: 전투 UI 컨트롤러

## 🎯 개발 규칙

### 1. 전투 상태 관리 규칙
- **상태 패턴**: 전투 상태를 명확히 구분
- **상태 전환**: 이벤트 기반 상태 변경
- **상태 검증**: 상태 전환 유효성 검증

### 2. 턴/슬롯 규칙(현행)
- **슬롯 고정**: `SLOT_1..SLOT_4` 고정. 초기 상태는 `1:P(빈), 2:E(카드), 3:P(빈), 4:E(카드)`
- **즉시 실행**: 1번 슬롯에 카드가 올라오면 즉시 실행(플레이어/적 공통)
- **교대 규칙**: 플레이어 1턴 → 적 1턴 → 플레이어 1턴 → 적 1턴 … 반복
- **슬롯 이동(Shift)**: 실행 종료 즉시 `2→1, 3→2, 4→3`, 4번은 비워짐
- **적 카드 예약**: 적 카드는 미리/수시로 4번 슬롯에 등록되어 Shift로 전진
- **가드 효과**: “다음 순서의 적 카드 1장 무효화” 후 즉시 소멸(수치/지속 없음)

### 3. Zenject DI 규칙
- **CombatInstaller**: 전투 시스템 의존성 주입 설정
- **인터페이스 기반**: DI 바인딩은 인터페이스 기반
- **생명주기 관리**: 적절한 스코프 설정

### 4. 서비스 패턴 규칙
- **CombatExecutorService**: 전투 실행 서비스
- **CombatPreparationService**: 전투 준비 서비스
- **의존성 주입**: 서비스 간 의존성 관리

## 🔧 사용 방법

### 기본 사용법(즉시 실행/교대)
```csharp
// 현재 턴 판정 (1번 슬롯 기준)
var turnType = turnManager.GetCurrentTurnType(); // Player 또는 Enemy

// 플레이어가 1번 슬롯에 카드를 올리는 순간 즉시 실행
executor.ExecuteImmediately(playerCard, CombatSlotPosition.SLOT_1);

// 실행 종료 후 내부적으로 슬롯 이동(2→1, 3→2, 4→3) → 1번이 적 카드라면 즉시 적 실행

// 적 카드 예약(필요 시)
turnManager.RegisterEnemyCardInSlot4(enemyCardDefinition);

// 가드 효과 적용(다음 적 카드 1장 무효화)
turnManager.ApplyGuardEffect();
```

### 전투 실행 서비스 사용법(핵심 메서드)
```csharp
// 1번 슬롯 즉시 실행
executor.ExecuteImmediately(card, CombatSlotPosition.SLOT_1);

// 슬롯 이동(내부에서 호출되지만, 필요 시 직접 호출 가능)
executor.MoveSlotsForward();
```

### 전투 준비 서비스 사용법(선택)
```csharp
// CombatPreparationService를 통한 전투 준비
CombatPreparationService preparationService = new CombatPreparationService(
    playerManager, 
    enemySpawnerManager, 
    enemyManager, 
    enemyHandManager, 
    turnCardRegistry, 
    placementService, 
    turnManager, 
    slotSelector, 
    slotRegistry
);

// 전투 준비 실행
StartCoroutine(preparationService.PrepareCombat());

// 적 카드 초기 등록/보충은 RegisterEnemyCardInSlot4()로 처리
```

### 상태 패턴 사용법
```csharp
// 전투 상태 구현
public class CustomCombatState : ICombatTurnState
{
    public void ExecuteState()
    {
        // 상태별 로직 실행
    }
    
    public bool CanTransitionTo(ICombatTurnState nextState)
    {
        // 상태 전환 조건 확인
        return true;
    }
    
    public void OnEnter()
    {
        // 상태 진입 시 처리
    }
    
    public void OnExit()
    {
        // 상태 종료 시 처리
    }
}

// 상태 설정
turnManager.SetState(new CustomCombatState());
```

## 🏗️ 아키텍처 패턴

### 1. 상태 패턴
- **전투 상태**: 다양한 전투 상태 관리
- **상태 전환**: 명확한 상태 전환 로직

### 2. 매니저 패턴
- **CombatFlowCoordinator**: 전투 플로우 조정
- **CombatTurnManager**: 턴 관리
- **CombatSlotManager**: 전투 슬롯 관리

### 3. 서비스 패턴
- **전투 서비스**: 전투 관련 비즈니스 로직
- **이벤트 서비스**: 전투 이벤트 처리

### 4. 옵저버 패턴
- **이벤트 시스템**: 전투 이벤트 발생 및 구독
- **상태 변경**: 상태 변경 시 알림

## 🔧 기술적 구현 세부사항

### 성능 최적화
- **이벤트 기반**: Update() 최소화
- **상태 캐싱**: 상태 정보 캐싱
- **메모리 관리**: 불필요한 참조 해제

### 스레드 안전성
- **상태 동기화**: 전투 상태 변경 동기화
- **턴 관리**: 턴 변경 시 동기화

## 🧪 검증/테스트 지침

### 체크리스트
- [ ] 1번 슬롯 즉시 실행 동작(플레이어/적) 확인
- [ ] 실행 후 슬롯 이동(2→1, 3→2, 4→3) 정상 동작
- [ ] 적 카드 4번 등록 → 자연스러운 전진 진입 확인
- [ ] 가드 효과로 “다음 적 카드 1장” 무효화 확인
- [ ] Zenject DI 바인딩 완전성 확인(Installer)

### 재현 절차
1. 전투 시작부터 종료까지 전체 플로우 테스트
2. 턴 관리 시나리오 테스트
3. 슬롯 배치 시나리오 테스트
4. 성능 프로파일링

## 📝 변경 기록(Delta)
- 형식: `YYYY-MM-DD | 작성자 | 변경 요약 | 영향도(코드/씬/문서)`

- 2025-01-27 | Maintainer | CombatSystem 개발 문서 초기 작성 | 문서
- 2025-01-27 | Maintainer | 실제 폴더 구조 반영 및 파일 수 정정 | 문서
- 2025-01-27 | Maintainer | .mdc 규칙 파일로 변환 및 Cursor 규칙 저장 | 문서
- 2025-01-27 | Maintainer | 실제 코드 분석 기반 구체적 클래스/메서드/서비스 정보 추가 | 문서
- 2025-01-27 | Maintainer | 가드 효과 시스템 통합 - ICombatTurnManager에 ApplyGuardEffect 메서드 추가 | 코드/문서
- 2025-09-15 | Maintainer | 4슬롯 교대(플레이어→적) 즉시 실행 규칙 및 API 반영 | 문서