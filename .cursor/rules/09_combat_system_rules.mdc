---
description: "CombatSystem 개발 가이드 및 규칙 - Unity 2D 전투 시스템 통합 관리"
globs: ["Assets/Script/CombatSystem/**/*.cs"]
rule_id: combat_system_rules
version: 1.2.0
alwaysApply: true
---

# CombatSystem 개발 규칙

## 📋 시스템 개요
CombatSystem은 새로운 5슬롯 시스템(1개 전투 슬롯 + 4개 대기 슬롯)을 축으로 즉시 실행 전투를 관리합니다. 플레이어는 전투 슬롯에만 카드를 드롭할 수 있으며, 적은 대기 슬롯에 카드를 배치합니다. 전투 슬롯에서 카드가 사용되면 턴이 완료되며, 고정된 순서(플레이어→적→플레이어→적)로 진행됩니다.

### 최근 변경(요약)
- **AnimationSystem 의존성 완전 제거**: 모든 AnimationSystem 관련 코드 제거 완료
- **임시 애니메이션 비활성화**: 애니메이션 호출 부분을 Debug.Log로 대체하여 게임 로직 정상 동작
- **새로운 5슬롯 시스템 완료**: 1개 전투 슬롯(BATTLE_SLOT) + 4개 대기 슬롯(WAIT_SLOT_1~4) 구현 완료
- **셋업 페이즈 완료**: 전투 시작 전 카드 배치 단계 구현 완료
- **즉시 실행 완료**: 전투 슬롯에서 카드 사용 시 즉시 실행 구현 완료
- **슬롯 이동 완료**: 대기 슬롯에서 전투 슬롯으로 순차 이동 구현 완료
- **레거시 호환성 완료**: 기존 4슬롯 시스템과의 호환성 유지 완료
- **Zenject DI 통합 완료**: 모든 CombatSystem 컴포넌트가 의존성 주입으로 전환 완료
- **CombatSecondAttackState 제거 완료**: 단일 `CombatAttackState`로 통합 완료
- **레거시 슬롯 최적화 완료**: 모든 `SLOT_1/SLOT_2` → `BATTLE_SLOT/WAIT_SLOT_1` 전환 완료
- **컴파일 에러 해결**: 모든 CombatSystem 관련 컴파일 에러 해결 완료

## 🏗️ 폴더 구조 규칙
```
CombatSystem/
├── Core/             # 핵심 로직 (2개 파일)
├── Manager/          # 매니저 클래스 (3개 파일)
├── Interface/        # 인터페이스 (8개 파일)
├── State/            # 상태 패턴 (6개 파일)
├── Service/          # 서비스 클래스 (3개 파일)
├── Data/             # 데이터 클래스 (1개 파일)
├── Event/            # 이벤트 시스템 (1개 파일)
├── Utility/          # 유틸리티 (2개 파일)
├── Context/          # 컨텍스트 (2개 파일)
└── UI/               # UI 관련 (1개 파일)
```

## 📁 주요 컴포넌트 규칙

### Core 폴더 규칙 (2개 파일)
- **CombatInstaller.cs**: 전투 시스템 의존성 주입 설정
- **CombatContext.cs**: 전투 컨텍스트

### Manager 폴더 규칙 (3개 파일)
- **CombatFlowCoordinator.cs**: 전투 플로우 조정
- **CombatTurnManager.cs**: 턴 매니저
- **CombatSlotManager.cs**: 전투 슬롯 매니저

### Interface 폴더 규칙 (8개 파일)
- **ICombatState.cs**: 전투 상태 인터페이스
- **ICombatAction.cs**: 전투 행동 인터페이스
- **ICombatEffect.cs**: 전투 효과 인터페이스
- **ICombatCard.cs**: 전투 카드 인터페이스
- **ICombatCharacter.cs**: 전투 캐릭터 인터페이스
- **ICombatUI.cs**: 전투 UI 인터페이스
- **ICombatValidator.cs**: 전투 검증 인터페이스
- **ICombatExecutor.cs**: 전투 실행 인터페이스

### State 폴더 규칙 (6개 파일)
- **CombatFirstAttackState.cs**: 첫 번째 공격 상태
- **CombatPlayerInputState.cs**: 플레이어 입력 상태
- **CombatPrepareState.cs**: 준비 상태
- **CombatResultState.cs**: 결과 상태
- **CombatSecondAttackState.cs**: 두 번째 공격 상태
- **CombatVictoryState.cs**: 승리 상태

### Service 폴더 규칙 (3개 파일)
- **CombatExecutorService.cs**: 전투 실행 서비스
- **CombatPreparationService.cs**: 전투 준비 서비스
- **TurnCardRegistry.cs**: 턴 카드 등록기

### Data 폴더 규칙 (1개 파일)
- **SlotOwner.cs**: 슬롯 소유자 열거형

### Event 폴더 규칙 (1개 파일)
- **CombatEventSystem.cs**: 전투 이벤트 시스템

### Utility 폴더 규칙 (2개 파일)
- **CardValidator.cs**: 카드 검증기
- **CharacterDeathHandler.cs**: 캐릭터 사망 핸들러

### Context 폴더 규칙 (2개 파일)
- **CombatContext.cs**: 전투 컨텍스트
- **TurnContext.cs**: 턴 컨텍스트

### UI 폴더 규칙 (1개 파일)
- **CombatUI.cs**: 전투 UI 컨트롤러

## 🎯 개발 규칙

### 1. 전투 상태 관리 규칙
- **상태 패턴**: 전투 상태를 명확히 구분
- **상태 전환**: 이벤트 기반 상태 변경
- **상태 검증**: 상태 전환 유효성 검증

### 2. 새로운 5슬롯 시스템 규칙
- **슬롯 구성**: 1개 전투 슬롯(BATTLE_SLOT) + 4개 대기 슬롯(WAIT_SLOT_1~4)
- **플레이어 액션**: 전투 슬롯에만 카드 드롭 가능
- **적 액션**: 대기 슬롯에 카드 배치
- **즉시 실행**: 전투 슬롯에서 카드 사용 시 즉시 실행
- **턴 완료 조건**: 전투 슬롯에서 카드 사용 시에만 턴 완료
- **고정 순서**: 플레이어→적→플레이어→적... (플레이어 시작)
- **슬롯 이동**: WAIT_SLOT_4→3→2→1→BATTLE_SLOT 순차 이동
- **셋업 페이즈**: 전투 시작 전 카드 배치 단계

### 3. 레거시 4슬롯 시스템 규칙(호환성 유지)
- **슬롯 고정**: `SLOT_1..SLOT_4` 고정. 초기 상태는 `1:P(빈), 2:E(카드), 3:P(빈), 4:E(카드)`
- **즉시 실행**: 1번 슬롯에 카드가 올라오면 즉시 실행(플레이어/적 공통)
- **교대 규칙**: 플레이어 1턴 → 적 1턴 → 플레이어 1턴 → 적 1턴 … 반복
- **슬롯 이동(Shift)**: 실행 종료 즉시 `2→1, 3→2, 4→3`, 4번은 비워짐
- **적 카드 예약**: 적 카드는 미리/수시로 4번 슬롯에 등록되어 Shift로 전진
- **가드 효과**: "다음 순서의 적 카드 1장 무효화" 후 즉시 소멸(수치/지속 없음)

### 4. Zenject DI 규칙
- **CombatInstaller**: 전투 시스템 의존성 주입 설정
- **인터페이스 기반**: DI 바인딩은 인터페이스 기반
- **생명주기 관리**: 적절한 스코프 설정

### 5. 서비스 패턴 규칙
- **CombatExecutorService**: 전투 실행 서비스
- **CombatPreparationService**: 전투 준비 서비스
- **의존성 주입**: 서비스 간 의존성 관리

## 🔧 사용 방법

### 새로운 5슬롯 시스템 사용법
```csharp
// 셋업 페이즈 시작
turnManager.StartSetupPhase();

// 셋업 단계별 카드 배치
turnManager.ProceedSetupStep(CombatSlotPosition.WAIT_SLOT_4, SlotOwner.Player);
turnManager.ProceedSetupStep(CombatSlotPosition.WAIT_SLOT_3, SlotOwner.Player);
turnManager.ProceedSetupStep(CombatSlotPosition.WAIT_SLOT_4, SlotOwner.Enemy);
// ... 셋업 완료까지 반복

// 셋업 완료 후 전투 페이즈로 전환
turnManager.CompleteSetup();

// 현재 페이즈 확인
CombatPhase currentPhase = turnManager.GetCurrentPhase(); // Setup, Battle, End

// 전투 슬롯에서 카드 실행
executor.ExecuteCardInBattleSlot();

// 슬롯 이동 (새로운 시스템)
executor.MoveSlotsForwardNew();

// 턴 완료 (전투 슬롯에서 카드 사용 시에만)
turnManager.CompleteTurn();

// 현재 턴 타입 확인 (새로운 시스템)
TurnType currentTurn = turnManager.GetCurrentTurnTypeNew(); // Player 또는 Enemy
```

### 레거시 4슬롯 시스템 사용법(호환성 유지)
```csharp
// 현재 턴 판정 (1번 슬롯 기준)
var turnType = turnManager.GetCurrentTurnType(); // Player 또는 Enemy

// 플레이어가 1번 슬롯에 카드를 올리는 순간 즉시 실행
executor.ExecuteImmediately(playerCard, CombatSlotPosition.SLOT_1);

// 실행 종료 후 내부적으로 슬롯 이동(2→1, 3→2, 4→3) → 1번이 적 카드라면 즉시 적 실행

// 적 카드 예약(필요 시)
turnManager.RegisterEnemyCardInSlot4(enemyCardDefinition);

// 가드 효과 적용(다음 적 카드 1장 무효화)
turnManager.ApplyGuardEffect();
```

### 전투 실행 서비스 사용법(핵심 메서드)
```csharp
// 1번 슬롯 즉시 실행
executor.ExecuteImmediately(card, CombatSlotPosition.SLOT_1);

// 슬롯 이동(내부에서 호출되지만, 필요 시 직접 호출 가능)
executor.MoveSlotsForward();
```

### 전투 준비 서비스 사용법(선택)
```csharp
// CombatPreparationService를 통한 전투 준비
CombatPreparationService preparationService = new CombatPreparationService(
    playerManager, 
    enemySpawnerManager, 
    enemyManager, 
    enemyHandManager, 
    turnCardRegistry, 
    placementService, 
    turnManager, 
    slotSelector, 
    slotRegistry
);

// 전투 준비 실행
StartCoroutine(preparationService.PrepareCombat());

// 적 카드 초기 등록/보충은 RegisterEnemyCardInSlot4()로 처리
```

### 상태 패턴 사용법
```csharp
// 전투 상태 구현
public class CustomCombatState : ICombatTurnState
{
    public void ExecuteState()
    {
        // 상태별 로직 실행
    }
    
    public bool CanTransitionTo(ICombatTurnState nextState)
    {
        // 상태 전환 조건 확인
        return true;
    }
    
    public void OnEnter()
    {
        // 상태 진입 시 처리
    }
    
    public void OnExit()
    {
        // 상태 종료 시 처리
    }
}

// 상태 설정
turnManager.SetState(new CustomCombatState());

// AnimationSystem 제거로 인한 임시 처리
// 전투 애니메이션은 Debug.Log로 대체됨
Debug.Log("[CombatSystem] 전투 애니메이션 재생 (임시 처리)");
```

## 🏗️ 아키텍처 패턴

### 1. 상태 패턴
- **전투 상태**: 다양한 전투 상태 관리
- **상태 전환**: 명확한 상태 전환 로직

### 2. 매니저 패턴
- **CombatFlowCoordinator**: 전투 플로우 조정
- **CombatTurnManager**: 턴 관리
- **CombatSlotManager**: 전투 슬롯 관리

### 3. 서비스 패턴
- **전투 서비스**: 전투 관련 비즈니스 로직
- **이벤트 서비스**: 전투 이벤트 처리

### 4. 옵저버 패턴
- **이벤트 시스템**: 전투 이벤트 발생 및 구독
- **상태 변경**: 상태 변경 시 알림

## 🔧 기술적 구현 세부사항

### 성능 최적화
- **이벤트 기반**: Update() 최소화
- **상태 캐싱**: 상태 정보 캐싱
- **메모리 관리**: 불필요한 참조 해제

### 스레드 안전성
- **상태 동기화**: 전투 상태 변경 동기화
- **턴 관리**: 턴 변경 시 동기화

## 📝 변경 기록(Delta)
- 형식: `YYYY-MM-DD | 작성자 | 변경 요약 | 영향도(코드/씬/문서)`

예)
- 2025-01-27 | Maintainer | CombatSystem 규칙 초기 제정 | 문서
- 2025-01-27 | Maintainer | 새로운 5슬롯 시스템 및 셋업 페이즈 규칙 추가 | 문서
- 2025-01-27 | Maintainer | 즉시 실행 및 슬롯 이동 규칙 추가 | 문서
- 2025-01-27 | Maintainer | 레거시 호환성 및 Zenject DI 규칙 추가 | 문서
- 2025-01-27 | Maintainer | AnimationSystem 의존성 완전 제거 및 임시 처리 추가 | 문서
