---
description: "AudioSystem 개발 가이드 및 규칙 - Unity 2D 오디오 시스템 통합 관리"
globs: ["Assets/Script/AudioSystem/**/*.cs", "Assets/Script/CoreSystem/Audio/**/*.cs"]
rule_id: audio_system_rules
version: 1.2.0
alwaysApply: true
---

# AudioSystem 개발 규칙

## 📋 시스템 개요
AudioSystem은 게임의 모든 오디오를 관리하는 시스템입니다. 오디오 풀링과 이벤트 기반 시스템을 제공하며, CoreSystem에 통합되어 전역적으로 관리됩니다.

## 🏗️ 폴더 구조 규칙
```
AudioSystem/
└── (빈 폴더)          # 실제 구현은 CoreSystem/Audio에 위치

CoreSystem/Audio/     # 실제 구현 위치
├── AudioManager.cs           # 오디오 매니저 (싱글톤)
├── AudioPoolManager.cs       # 오디오 풀링 매니저
└── AudioEventTrigger.cs      # 오디오 이벤트 트리거
```

## 📁 주요 컴포넌트 규칙

### AudioManager.cs 규칙
- **싱글톤 패턴**: Instance 프로퍼티를 통한 전역 접근
- **ICoreSystemInitializable**: CoreSystem 초기화 인터페이스 구현
- **오디오 소스 관리**: BGM용, SFX용 AudioSource 분리 관리
- **페이드 효과**: BGM 전환 시 부드러운 페이드 인/아웃
- **오디오 풀링**: AudioPoolManager를 통한 사운드 중복 방지
- **볼륨 제어**: BGM, SFX 볼륨 개별 제어

### AudioPoolManager.cs 규칙
- **AudioSource 풀링**: 미리 생성된 AudioSource 풀 관리
- **사운드 중복 방지**: 쿨다운 시스템으로 동일 사운드 중복 재생 방지
- **우선순위 시스템**: 사운드별 우선순위 설정으로 중요한 사운드 우선 재생
- **자동 풀 반환**: 재생 완료 후 AudioSource 자동 풀 반환

### AudioEventTrigger.cs 규칙
- **이벤트 기반**: 게임 이벤트와 자동 연동
- **전용 사운드**: 카드 사용, 적 처치 등 전용 사운드 메서드

## 🎯 주요 기능

1. **통합 오디오 관리**: BGM과 SFX를 중앙화된 방식으로 관리
2. **오디오 풀링 시스템**: AudioSource 재사용을 통한 성능 최적화
3. **우선순위 시스템**: 사운드별 우선순위 설정으로 중요한 사운드 우선 재생
4. **쿨다운 시스템**: 동일 사운드 중복 재생 방지
5. **페이드 효과**: BGM 전환 시 부드러운 페이드 인/아웃
6. **이벤트 기반 사운드**: 게임 이벤트와 자동 연동되는 사운드 시스템
7. **볼륨 제어**: 마스터, BGM, SFX 볼륨 개별 제어
8. **CoreSystem 통합**: 전역 오디오 시스템으로 통합 관리

## 🎯 개발 규칙

### 1. 오디오 매니저 규칙
- **싱글톤 패턴**: Instance 프로퍼티를 통한 전역 접근
- **오디오 소스 관리**: 여러 AudioSource를 통한 동시 재생 지원
- **볼륨 제어**: 마스터, BGM, SFX 볼륨 개별 제어
- **페이드 효과**: BGM 페이드 인/아웃 지원

### 2. 오디오 풀링 규칙
- **AudioPoolManager**: 사운드 중복 방지
- **메모리 최적화**: 오디오 소스 재사용
- **성능 향상**: 오디오 소스 생성 비용 절약

### 3. 이벤트 기반 규칙
- **AudioEventTrigger**: 게임 이벤트 연동
- **자동 사운드**: 이벤트 발생 시 자동 사운드 재생
- **커스터마이징**: 이벤트별 사운드 커스터마이징

### 4. 사운드 우선순위 규칙
- **전투 사운드**: 우선순위 6-10 (높음)
- **UI 사운드**: 우선순위 3-5 (중간)
- **기타 사운드**: 우선순위 1-2 (낮음)

## 🔧 주요 클래스 및 메서드

### AudioManager 클래스
- **Instance**: 싱글톤 인스턴스 (프로퍼티)
- **PlayBGM()**: BGM 재생 (페이드 인 옵션 지원)
- **PlaySFX()**: 효과음 재생 (기본 방식)
- **PlaySFXWithPool()**: 효과음 재생 (풀링 사용, 우선순위 지정)
- **StopBGM()**: BGM 정지
- **SetBGMVolume()**: BGM 볼륨 설정
- **SetSFXVolume()**: SFX 볼륨 설정
- **Initialize()**: 오디오 시스템 초기화
- **IsInitialized**: 초기화 상태 (프로퍼티)

### AudioPoolManager 클래스
- **PlaySound()**: 사운드 재생 (우선순위 지정 가능)
- **IsInCooldown()**: 쿨다운 상태 확인
- **SetCooldown()**: 쿨다운 설정
- **GetAvailableSource()**: 사용 가능한 AudioSource 조회
- **ReturnSource()**: AudioSource 풀 반환

### AudioEventTrigger 클래스
- **OnCardUsed()**: 카드 사용 시 사운드 재생
- **OnEnemyDefeated()**: 적 처치 시 사운드 재생
- **OnButtonClicked()**: 버튼 클릭 시 사운드 재생
- **OnSkillActivated()**: 스킬 활성화 시 사운드 재생

## 🔧 사용 방법

### 기본 사용법
```csharp
// BGM 재생 (AudioClip 직접 전달)
AudioClip mainTheme = Resources.Load<AudioClip>("Sounds/BGM/MainTheme");
AudioManager.Instance.PlayBGM(mainTheme, true); // 페이드 인 옵션

// 효과음 재생 (기본 방식)
AudioClip buttonClick = Resources.Load<AudioClip>("Sounds/SFX/ButtonClick");
AudioManager.Instance.PlaySFX(buttonClick);

// 효과음 재생 (풀링 사용, 중복 방지)
AudioClip cardUse = Resources.Load<AudioClip>("Sounds/SFX/CardUse");
AudioManager.Instance.PlaySFXWithPool(cardUse, 1.0f, 8); // 볼륨, 우선순위

// 볼륨 설정
AudioManager.Instance.SetBGMVolume(0.6f);
AudioManager.Instance.SetSFXVolume(1.0f);

// BGM 정지
AudioManager.Instance.StopBGM();
```

### AudioPoolManager 직접 사용법
```csharp
// AudioPoolManager를 통한 고급 사운드 제어
AudioPoolManager poolManager = AudioManager.Instance.GetComponent<AudioPoolManager>();

// 우선순위 지정 사운드 재생
AudioClip enemyDefeat = Resources.Load<AudioClip>("Sounds/SFX/EnemyDefeat");
poolManager.PlaySound(enemyDefeat, 1.0f, 10); // 높은 우선순위

// 자동 우선순위 사운드 재생
AudioClip skillActivation = Resources.Load<AudioClip>("Sounds/SFX/SkillActivation");
poolManager.PlaySound(skillActivation, 0.8f); // 우선순위 자동 설정

// 쿨다운 상태 확인
if (!poolManager.IsInCooldown("ButtonClick"))
{
    poolManager.PlaySound(buttonClickClip, 0.7f);
}
```

### 사운드 우선순위 활용
```csharp
// 전투 사운드 (높은 우선순위) - 다른 사운드보다 우선 재생
poolManager.PlaySound(enemyDefeatClip, 1.0f, 10);
poolManager.PlaySound(skillActivationClip, 1.0f, 9);

// UI 사운드 (중간 우선순위)
poolManager.PlaySound(buttonClickClip, 0.7f, 5);
poolManager.PlaySound(cardDragClip, 0.5f, 4);

// 기타 사운드 (낮은 우선순위)
poolManager.PlaySound(ambientClip, 0.3f, 1);
```

### CoreSystem 초기화 연동
```csharp
// ICoreSystemInitializable 구현으로 자동 초기화
// CoreSystemInitializer에서 자동으로 Initialize() 호출됨

// 초기화 상태 확인
if (AudioManager.Instance.IsInitialized)
{
    // 오디오 시스템 사용 가능
    AudioManager.Instance.PlayBGM(bgmClip);
}
```

## 🏗️ 아키텍처 패턴

### 1. 싱글톤 패턴
- **AudioManager**: 전역 오디오 관리
- **Instance 접근**: 어디서든 접근 가능

### 2. 풀링 패턴
- **AudioPoolManager**: 오디오 소스 풀링
- **재사용**: 오디오 소스 재사용으로 성능 향상

### 3. 이벤트 패턴
- **AudioEventTrigger**: 이벤트 기반 사운드 재생
- **자동화**: 이벤트 발생 시 자동 사운드 재생

### 4. 전략 패턴
- **우선순위 시스템**: 사운드별 우선순위 전략
- **쿨다운 시스템**: 사운드 중복 방지 전략

## 🔧 기술적 구현 세부사항

### 성능 최적화
- **오디오 풀링**: 오디오 소스 재사용으로 성능 향상
- **메모리 관리**: 불필요한 오디오 소스 해제
- **압축**: 오디오 파일 압축으로 메모리 절약

### 스레드 안전성
- **싱글톤 안전성**: 스레드 안전한 싱글톤 구현
- **동시 재생**: 여러 사운드 동시 재생 지원

### 메모리 관리
- **리소스 해제**: 오디오 클립 사용 완료 후 해제
- **메모리 누수 방지**: 불필요한 참조 해제

## 🏗️ 시스템 아키텍처

### 의존성 다이어그램
```mermaid
graph TD
    A[AudioManager] --> B[AudioPoolManager]
    A --> C[AudioEventTrigger]
    A --> D[CoreSystemInitializer]
    B --> E[AudioSource Pool]
    C --> F[Game Events]
    D --> G[ICoreSystemInitializable]
    E --> H[Sound Playback]
    F --> I[Card Events]
    F --> J[UI Events]
    F --> K[Combat Events]
```

### 클래스 다이어그램
```mermaid
classDiagram
    class AudioManager {
        +Instance: AudioManager
        +PlayBGM()
        +PlaySFX()
        +PlaySFXWithPool()
        +StopBGM()
        +SetBGMVolume()
        +SetSFXVolume()
    }
    
    class AudioPoolManager {
        +PlaySound()
        +IsInCooldown()
        +SetCooldown()
        +GetAvailableSource()
        +ReturnSource()
    }
    
    class AudioEventTrigger {
        +OnCardUsed()
        +OnEnemyDefeated()
        +OnButtonClicked()
        +OnSkillActivated()
    }
    
    class ICoreSystemInitializable {
        <<interface>>
        +Initialize()
        +IsInitialized: bool
    }
    
    AudioManager --> AudioPoolManager
    AudioManager --> AudioEventTrigger
    AudioManager --> ICoreSystemInitializable
```

### 시퀀스 다이어그램
```mermaid
sequenceDiagram
    participant Client
    participant AudioManager
    participant AudioPoolManager
    participant AudioSource
    participant AudioClip
    
    Client->>AudioManager: PlaySFXWithPool(clip, volume, priority)
    AudioManager->>AudioPoolManager: PlaySound(clip, volume, priority)
    AudioPoolManager->>AudioSource: PlayOneShot(clip, volume)
    AudioSource->>AudioClip: Play()
    AudioClip-->>AudioSource: Sound Complete
    AudioSource-->>AudioPoolManager: OnAudioSourceFinished()
    AudioPoolManager-->>AudioManager: ReturnSource()
    AudioManager-->>Client: Sound Playing
```

## 🧪 검증/테스트 지침

### 체크리스트
- [ ] 오디오 재생 기능 정상 동작 확인
- [ ] 볼륨 제어 기능 검증
- [ ] 페이드 효과 정상 동작 확인
- [ ] 오디오 풀링 성능 확인
- [ ] 이벤트 기반 사운드 재생 확인
- [ ] 우선순위 시스템 정상 동작 확인
- [ ] 쿨다운 시스템 정상 동작 확인

### 재현 절차
1. 각 오디오 타입별 재생 테스트
2. 볼륨 제어 시나리오 테스트
3. 페이드 효과 시나리오 테스트
4. 성능 프로파일링

## 📚 참고 자료

### 관련 문서
- [CoreSystem 개발 문서](../CoreSystem/CoreSystem_개발문서.md)
- [AnimationSystem 개발 문서](../AnimationSystem/AnimationSystem_개발문서.md)
- [CombatSystem 개발 문서](../CombatSystem/CombatSystem_개발문서.md)

### Unity 문서
- [Unity Audio System](https://docs.unity3d.com/Manual/Audio.html)
- [AudioSource Component](https://docs.unity3d.com/Manual/class-AudioSource.html)
- [AudioClip](https://docs.unity3d.com/Manual/class-AudioClip.html)

### 디자인 패턴
- [Singleton Pattern](https://refactoring.guru/design-patterns/singleton)
- [Object Pool Pattern](https://refactoring.guru/design-patterns/object-pool)
- [Observer Pattern](https://refactoring.guru/design-patterns/observer)

## 📝 변경 기록(Delta)
- 형식: `YYYY-MM-DD | 작성자 | 변경 요약 | 영향도(코드/씬/문서)`

- 2025-01-27 | Maintainer | AudioSystem 개발 문서 초기 작성 | 문서
- 2025-01-27 | Maintainer | 실제 구현 위치 명시 및 폴더 구조 정정 | 문서
- 2025-01-27 | Maintainer | .mdc 규칙 파일로 변환 및 Cursor 규칙 저장 | 문서
- 2025-01-27 | Maintainer | 실제 코드 분석 기반 구체적 클래스/메서드/우선순위 정보 추가 | 문서
- 2025-01-27 | Maintainer | 개발 문서 기반 규칙 파일 업데이트 (주요 기능, 클래스/메서드, 아키텍처 다이어그램 추가) | 문서