---
description: 안전하고 단계적인 리팩토링 규칙(의사결정/단계/품질 게이트/문서 동기화)
globs: ["Assets/Script/**"]
alwaysApply: true
---

# 리팩토링 규칙 (Production)

> 목적: 기능 변경 없이 구조·가독성·성능·안정성을 개선하되, 회귀 없이 빠르게 병합 가능한 리팩토링 표준을 제공한다. Cursor 도구를 활용해 안전/가시성/일관성을 보장한다.

## 1) 적용 범위와 원칙
- 범위: `Assets/Script/**` 전역. 시스템별 폴더/네임스페이스 규칙을 준수한다.
- 원칙: 기능 동일성 유지(Behavioral Equivalence) → 작은 단위 → 즉시 검증 → 문서/테스트 동기화.
- Single Source of Truth: 규칙·문서·코드 간 중복을 제거한다.

## 2) 리팩토링 착수 기준(의사결정 트리)
- 필요 조건 중 1개 이상이면 착수:
  - 중복 코드 ≥ 2곳, 또는 같은 패턴의 변형이 반복
  - 네이밍/폴더/네임스페이스가 규칙과 불일치
  - 함수 길이/복잡도 과다, 경고/린트 누적
  - 성능 Hot Path에서 불필요한 할당/Update 빈번
  - 예외/로깅/검증 누락으로 안정성 저하
  - AnimationSystem 제거로 인한 의존성 정리 필요
- 금지: 요구사항 불명확, 테스트 불가, 대규모 설계 변경이 필요한 경우(별도 설계/PR로 분리)

## 3) 단계별 절차(작게, 안전하게)
1) 탐색: 유사 코드/기존 구현 검색(codebase_search → grep) 후 재사용/통합 방안 도출
2) 계획: 변경 범위 식별(파일/클래스/공개 API), 위험/롤백 포인트 정의
3) 실행: 원자적 커밋으로 작은 단위 변경; 네이밍/타입/폴더는 일관 일괄 적용
4) 검증: 컴파일/린트 0 → 수동 체크리스트 → 플레이/단위 테스트
5) 동기화: 관련 문서/씬 제작 문서/Delta 업데이트
 - 신규 파일 추가 시: 동일/유사 역할 스크립트 존재 여부를 먼저 확인하고, 재사용/확장 우선. 불가 사유를 PR에 기록.

## 3-α) Todo 기반 작업 관리(필수)
- 모든 리팩토링은 Todo를 생성하고 상태로 추적한다: `pending → in_progress → completed/cancelled`.
- 작업 단위: 5분 이상 소요되는 의미 있는 변경만 Todo로 작성(파일 생성/리네임/DI 적용/성능 수정 등).
- 규칙:
  - 새 단계 시작 전: 직전 Todo를 `completed`로 마감 후 다음 Todo를 `in_progress`로 설정.
  - 병렬 작업 금지: 동시에 1개만 `in_progress` 유지.
  - 상태 변경 즉시 기록: 완료 직후 체크리스트/Delta도 동기화.

## 3-β) Todo 운영 지침(완수 기준)
- Todo 본문 구성(필수): 목적, 산출물, 영향 범위, 위험/롤백 포인트.
- 수용 기준(체크박스 3~7개): 기능 동일성, 경고 0, 테스트/재현, 문서/Delta 동기화 등.
- 의존 관계: 선행 Todo 명시, 종속 Todo는 선행 완료 후 진행.
- 증빙(필수): 변경 요약, 커밋/PR 링크, 로그/스크린샷(필요 시), 변경 파일 목록.
- 시간 관리: 30~60분 마일스톤. 초과 시 리스크/우회 전략 갱신.
- 자동 취소: 범위/요구 변경 시 즉시 `cancelled` 처리하고 대체 Todo 생성.

## 4) 변경 규칙(코드 스타일·아키텍처)
- 네이밍: 의미 기반 풀네임, 약어 금지, 인터페이스 `I*`, Manager/Factory/Helper/Controller 접미사.
- 구조: 가드절/조기 반환, 깊은 중첩 지양, 예외는 의미 있게 처리, 퍼블릭 API XML 문서화.
- 성능: Update 최소화, 할당 줄이기, async/await 우선, 필요 시 객체 풀.
- 아키텍처: DI(Zenject) 우선, 이벤트/전략/상태 패턴 준수, 폴더=네임스페이스.

## 5) 안전 장치(회귀 방지)
- 공개 메서드 매개변수 검증(null/범위) + `ArgumentNullException`/`InvalidOperationException`.
- 한국어 로깅(`GameLogger.Info/Warning/Error`)으로 전/후 상태를 명확히 기록.
- 파일 이동은 삭제/재생성 금지(`git mv`/IDE 이동)로 히스토리 보존.

## 6) Cursor 도구 사용 규칙
- 탐색: codebase_search(광역) → grep(정확) → read_file(컨텍스트)
- 편집: edit_file(소규모) / apply_patch(다중/넓은 범위). 직전 read_file로 컨텍스트 재확인.
- 병렬화: 독립 검색/읽기는 multi_tool_use.parallel로 동시 실행.
- 린트: 변경 직후 read_lints로 경고/에러 0 보장.
- 터미널: run_terminal_cmd는 비대화식 플래그, pager 금지(`| cat`), 장기 실행은 백그라운드.

### 6-α) Todo 연동 규칙
- todo_write를 사용해 단계 착수/완료 시점을 기록한다.
- 병렬로 독립 변경이 2건 이상 필요한 경우에도 Todo는 순차로 관리(충돌 방지).
- 장기 실행 작업은 `is_background: true`로 구동하고 Todo에 링크/로그를 첨부.

### 6-β) Todo 품질 기준
- Todo는 동사로 시작하고 14자 이내 요약 + 상세 본문 링크.
- Acceptance Criteria는 수량 기반 검증 항목 포함(예: "경고 0", "테스트 N개 통과").
- 완료 시 Acceptance Criteria 전부 체크되지 않으면 `completed` 불가.

## 7) PR 품질 게이트(머지 전 필수)
- 컴파일 경고 0, 린트 0, 플레이 시 경고/에러 0.
- 공개 API 시그니처 변경 시 마이그레이션 노트/영향도 명시(가능하면 분리 PR).
- 문서/씬 제작 문서 동기화 및 Delta 최신화.
- 테스트: 최소 한 개 이상 재현 절차 또는 단위 테스트 추가/갱신.
 - 신규 스크립트 생성 시: 기존 스크립트 검색/재사용 검토 결과를 체크리스트에 첨부.
 - Todo 증빙 필수: 초기 계획 Todo, 진행 중 스냅샷(최소 1회), 완료 Todo 링크를 PR에 첨부.

## 8) 리뷰 심각도 기준(수치화)
- BLOCKER:
  - 문서-코드/씬 값 불일치, Delta 누락
  - 공개 API 변경 미고지 또는 컴파일/런타임 경고 존재
  - 폴더≠네임스페이스 불일치/파일 이동 히스토리 손실
- HIGH:
  - 상대 경로 위반, 로깅/검증 누락, 테스트/체크리스트 불충분
- MEDIUM/LOW: 표현/형식/정렬 경미 이슈(동작 영향 없음)

## 9) 커밋/브랜치 전략
- 원자적 커밋: 한 가지 의도만. 대규모 리네임은 별도 커밋.
- 커밋 메시지: `[Refactor] 영역: 요약 (영향도)` 형식.
- 브랜치: 기능/리팩토링 분리, PR 설명에 영향도와 관련 문서 링크 포함.

## 10) 마이그레이션/Deprecated 처리
- 삭제 전 Deprecated 주기 설정(버전/날짜), 대체 API 제시, 사용처 제거 계획 포함.
- 마이그레이션 가이드: 변환 맵(타입/메서드/리소스 경로), 자동/수동 작업 분류.

## 11) 체크리스트(요약)
- [ ] 기존 코드 재사용/통합 방안 확인
- [ ] 공개 API 변경 없음(또는 마이그레이션 문서 제공)
- [ ] 네이밍/폴더/네임스페이스 일관화
- [ ] 예외/로깅/검증 보강(한국어)
- [ ] 성능 Hot Path 최적화(할당/Update)
- [ ] 문서/씬 제작 문서/Delta 동기화
- [ ] 경고 0, 테스트/재현 절차 통과

## 12) 변경 기록(Delta)
- 형식: `YYYY-MM-DD | 작성자 | 변경 요약 | 영향도(코드/씬/문서)`

예)
- 2025-09-09 | Maintainer | 리팩토링 규칙 신규 제정(단계/게이트/도구) | 문서
 - 2025-09-09 | Maintainer | Todo 기반 진행/PR 증빙 의무화 | 문서
 - 2025-09-09 | Maintainer | Todo 운영/트레이서빌리티/품질 기준 추가 | 문서
- 2025-01-27 | Maintainer | AnimationSystem 제거로 인한 리팩토링 규칙 추가 | 문서

