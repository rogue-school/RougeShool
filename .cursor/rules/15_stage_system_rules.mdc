---
description: "StageSystem 개발 가이드 및 규칙 - Unity 2D 스테이지 시스템 통합 관리"
globs: ["Assets/Script/StageSystem/**/*.cs"]
rule_id: stage_system_rules
version: 1.2.0
alwaysApply: false
---

# StageSystem 개발 규칙

## 📋 시스템 개요
StageSystem은 게임의 스테이지 진행을 관리하는 시스템입니다. 각 스테이지는 SubBoss와 Boss로 구성되며, 스테이지 완료 시 보상과 함께 다음 스테이지로 진행됩니다. 팩토리 패턴을 통한 스테이지 데이터 생성, 상태 기반 스테이지 관리, 이벤트 기반 보상 시스템을 제공합니다.

### 최근 변경(요약)
- **AnimationSystem 의존성 완전 제거**: 모든 AnimationSystem 관련 코드 제거 완료
- **임시 애니메이션 비활성화**: 애니메이션 호출 부분을 Debug.Log로 대체하여 게임 로직 정상 동작
- **팩토리 패턴 완료**: StageDataFactory를 통한 스테이지 데이터 생성 및 관리 완료
- **상태 기반 관리 완료**: 스테이지 진행 상태를 명확히 구분하여 관리 완료
- **이벤트 기반 보상 완료**: 스테이지 완료 시 이벤트 기반 보상 지급 완료
- **ScriptableObject 기반 완료**: 스테이지 데이터를 에셋으로 관리 완료
- **런타임 인스턴스 완료**: 게임 중 동적 생성/수정 지원 완료
- **Zenject DI 통합 완료**: 모든 StageSystem 컴포넌트가 의존성 주입으로 전환 완료
- **컴파일 에러 해결**: 모든 StageSystem 관련 컴파일 에러 해결 완료

## 🏗️ 폴더 구조 규칙
```
StageSystem/
├── Manager/          # 스테이지 매니저 (2개 파일)
├── Interface/        # 스테이지 인터페이스 (3개 파일)
├── Factory/          # 스테이지 팩토리 (1개 파일)
└── Data/             # 스테이지 데이터 (3개 파일)
```

## 📁 주요 컴포넌트 규칙

### Manager 폴더 규칙 (2개 파일)
- **StageManager.cs**: 스테이지 전체 관리
- **StageProgressController.cs**: 스테이지 진행 관리

### Interface 폴더 규칙 (3개 파일)
- **IStageManager.cs**: 스테이지 매니저 인터페이스
- **IStagePhaseManager.cs**: 스테이지 단계 관리 인터페이스
- **IStageRewardManager.cs**: 스테이지 보상 관리 인터페이스

### Factory 폴더 규칙 (1개 파일)
- **StageDataFactory.cs**: 스테이지 데이터 생성 팩토리

### Data 폴더 규칙 (3개 파일)
- **StageData.cs**: 스테이지 데이터 (ScriptableObject)
- **StagePhaseState.cs**: 스테이지 단계 상태 열거형
- **StageRewardData.cs**: 스테이지 보상 데이터

## 🎯 개발 규칙

### 1. 스테이지 구성 규칙
- **SubBoss + Boss**: 각 스테이지는 SubBoss와 Boss로 구성
- **스테이지 진행**: SubBoss → Boss 순서로 진행
- **스테이지 완료**: Boss 처치 시 스테이지 완료

### 2. 스테이지 관리 규칙
- **현재 스테이지**: 현재 진행 중인 스테이지 추적
- **스테이지 상태**: 진행 중, 완료, 실패 등 상태 관리
- **스테이지 전환**: 스테이지 간 전환 처리

### 3. 보상 시스템 규칙
- **스테이지 완료 보상**: 스테이지 완료 시 보상 지급
- **보상 데이터**: ScriptableObject 기반 보상 설정
- **보상 적용**: 보상 지급 및 적용

### 4. 진행 관리 규칙
- **적 처치 추적**: 적 처치 시 진행 상황 업데이트
- **스테이지 완료 조건**: 스테이지 완료 조건 확인
- **다음 스테이지**: 다음 스테이지로 자동 진행

### 5. 팩토리 패턴 규칙
- **StageDataFactory**: 스테이지 데이터 생성 및 관리 팩토리
- **동적 생성**: 런타임에 스테이지 데이터 동적 생성
- **설정 기반**: 매개변수를 통한 스테이지 데이터 설정
- **타입 안전성**: 강타입 스테이지 데이터 생성

## 🔧 사용 방법

### 기본 사용법
```csharp
// StageManager를 통한 스테이지 관리
StageManager stageManager = FindObjectOfType<StageManager>();
stageManager.StartSubBossPhase();
stageManager.StartBossPhase();
stageManager.CompleteStage();
stageManager.FailStage();

// StageDataFactory를 통한 스테이지 데이터 생성
StageDataFactory factory = new StageDataFactory();
StageData newStage = factory.CreateStageData(
    "Stage_001",
    new StagePhaseData(EnemyType.Goblin, 3),
    new StagePhaseData(EnemyType.Orc, 1),
    new List<RewardData>() { new RewardData(RewardType.Gold, 100) }
);
```

### 팩토리 패턴 사용법
```csharp
// StageDataFactory를 통한 동적 스테이지 생성
StageDataFactory factory = new StageDataFactory();

// 기본 스테이지 생성
StageData basicStage = factory.CreateStageData(
    "BasicStage_001",
    new StagePhaseData(EnemyType.Goblin, 2), // SubBoss: 고블린 2마리
    new StagePhaseData(EnemyType.Orc, 1),    // Boss: 오크 1마리
    new List<RewardData>() { 
        new RewardData(RewardType.Gold, 100),
        new RewardData(RewardType.Experience, 50)
    }
);

// 고급 스테이지 생성
StageData advancedStage = factory.CreateStageData(
    "AdvancedStage_001",
    new StagePhaseData(EnemyType.Dragon, 1), // SubBoss: 드래곤 1마리
    new StagePhaseData(EnemyType.BossDragon, 1), // Boss: 보스 드래곤 1마리
    new List<RewardData>() { 
        new RewardData(RewardType.Gold, 500),
        new RewardData(RewardType.Experience, 200),
        new RewardData(RewardType.Item, 1)
    }
);

// 스테이지 데이터 검증
if (basicStage.IsValid())
{
    Debug.Log("스테이지 데이터가 유효합니다.");
}

// 스테이지 매니저에 등록
stageManager.RegisterStage(basicStage);
stageManager.RegisterStage(advancedStage);

// AnimationSystem 제거로 인한 임시 처리
// 스테이지 애니메이션은 Debug.Log로 대체됨
Debug.Log("[StageSystem] 스테이지 애니메이션 재생 (임시 처리)");
```

### 주요 클래스 및 메서드

#### StageManager 클래스
- **StartSubBossPhase()**: 서브 보스 페이즈 시작
- **StartBossPhase()**: 보스 페이즈 시작
- **CompleteStage()**: 스테이지 완료 처리
- **FailStage()**: 스테이지 실패 처리
- **ProceedToNextStage()**: 다음 스테이지로 진행
- **OnStageCompleted**: 스테이지 완료 이벤트
- **OnStageFailed**: 스테이지 실패 이벤트
- **CurrentStageData**: 현재 스테이지 데이터 (프로퍼티)

#### StageDataFactory 클래스
- **CreateStageData()**: 스테이지 데이터 생성

#### StagePhaseData 클래스
- **EnemyType**: 등장 적 타입 (프로퍼티)
- **EnemyCount**: 등장 적 수 (프로퍼티)

#### IStageRewardManager 인터페이스
- **GrantRewards()**: 스테이지 보상 지급

## 🏗️ 아키텍처 패턴

### 1. 매니저 패턴
- **StageManager**: 스테이지 전체 관리
- **StageProgressController**: 스테이지 진행 관리

### 2. 팩토리 패턴
- **StageDataFactory**: 스테이지 데이터 생성 및 관리

### 3. 데이터 기반 설계
- **ScriptableObject**: 스테이지 데이터를 에셋으로 관리
- **런타임 인스턴스**: 게임 중 동적 생성/수정

### 4. 이벤트 기반 아키텍처
- **스테이지 이벤트**: 스테이지 진행 관련 이벤트 발생
- **보상 이벤트**: 보상 지급 이벤트 발생

## 🔧 기술적 구현 세부사항

### 성능 최적화
- **메모리 관리**: 스테이지 데이터 사전 로딩 및 캐싱
- **프레임 최적화**: 스테이지 전환 시 프레임 블로킹 방지
- **로딩 최적화**: 비동기 스테이지 로딩

### 스레드 안전성
- **동시성 제어**: 스테이지 상태 변경 시 동시성 제어
- **비동기 처리**: async/await 패턴을 통한 비동기 스테이지 처리
- **이벤트 처리**: 스레드 안전한 스테이지 이벤트 시스템

### 메모리 관리
- **생명주기 관리**: 스테이지 객체의 생성/소멸 관리
- **리소스 해제**: 스테이지 완료 시 리소스 정리
- **메모리 누수 방지**: 이벤트 구독 해제, 스테이지 참조 해제

## 📝 변경 기록(Delta)
- 형식: `YYYY-MM-DD | 작성자 | 변경 요약 | 영향도(코드/씬/문서)`

예)
- 2025-01-27 | Maintainer | StageSystem 규칙 초기 제정 | 문서
- 2025-01-27 | Maintainer | 팩토리 패턴 및 상태 기반 관리 규칙 추가 | 문서
- 2025-01-27 | Maintainer | 이벤트 기반 보상 시스템 및 ScriptableObject 규칙 추가 | 문서
- 2025-01-27 | Maintainer | 런타임 인스턴스 및 Zenject DI 규칙 추가 | 문서
- 2025-01-27 | Maintainer | AnimationSystem 의존성 완전 제거 및 임시 처리 추가 | 문서
